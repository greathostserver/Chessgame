const BOT_TOKEN = '7405669928:AAFLUFwBwq3cMTDZkIC75SHBthb0xbieGC4'; // توکن ربات از Bot Father
const ADMINS = ["Rover_trail", "rover_trail"]; // لیست ادمین‌ها (بدون @)
const BOT_ID = "eiks_bot"; // آیدی ربات (بدون @)

export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);

    const botValues = env.bot_values_link; // ایجاد یک KV و اتصال به Worker -> bot_values_link
    const botDB = env.dblink; // ایجاد یک دیتابیس D1 و اتصال به Worker -> dblink

    async function postReq(url, fields) {
      const tgFormData = new FormData();

      fields.forEach(obj => {
        for (let key in obj) {
          tgFormData.append(key, obj[key]);
        }
      });

      const telegramResponse = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/${url}`, {
        method: 'POST',
        body: tgFormData,
      });

      return await telegramResponse;
    }

    // بررسی عضویت کاربر در کانال‌ها
    const checkMember = async (chatId, postid) => {
      const requestPost = await botDB.prepare(`SELECT * FROM posts WHERE id = ?`).bind(postid).first();

      const channels = requestPost.channels.trim().split('\n').map(line => {
        const [id, ...titleParts] = line.split(' ');
        return { id, title: titleParts.join(' ') };
      });

      let isMember = [];
      for (const channel of channels) {
        try {
          const check_member = await postReq(`getChatMember`, [
            { "chat_id": channel.id },
            { "user_id": chatId }
          ]);

          const check_member_json = await check_member.json();

          if (check_member_json.result.status == "member" || check_member_json.result.status == "creator") {
            isMember.push(channel.id);
          }
        } catch (e) {
          // خطا را نادیده بگیر
        }
      }

      if (channels.length > 0 && channels.length == isMember.length) {
        // اگر کاربر در همه کانال‌ها عضو است، فایل ارسال شود
        await postReq(`copyMessage`, [
          { "chat_id": chatId },
          { "from_chat_id": requestPost.from_chat_id },
          { "message_id": requestPost.message_id }
        ]);

        try {
          await postReq(`deleteMessage`, [
            { "chat_id": chatId },
            { "message_id": await botValues.get("registerMsg_" + chatId) }
          ]);
        } catch (e) {
          // خطا را نادیده بگیر
        }

        return true;
      } else {
        // اگر کاربر در همه کانال‌ها عضو نیست، پیام خطا نمایش داده شود
        await postReq(`sendMessage`, [
          { "chat_id": chatId },
          { "text": "شما در تعدادی از لینک‌های موجود هنوز عضو نشده‌اید. مجدد تلاش کنید." }
        ]);

        return false;
      }
    };

    // تنظیم Webhook
    if (url.pathname === "/init") {
      try {
        const array = new Uint8Array(32);
        crypto.getRandomValues(array);
        const webhookkey = Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
        await botValues.put("webhookkey", webhookkey);

        const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/setWebhook`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            url: `${url.protocol}//${url.hostname}/hook/${webhookkey}`
          })
        });

        const result = await response.json();
        if (result.ok) {
          return new Response("Webhook successfully set!", { status: 200 });
        } else {
          return new Response(`Failed to set webhook: ${result.description}`, { status: 400 });
        }
      } catch (error) {
        return new Response(`Error setting webhook: ${error.message}`, { status: 500 });
      }
    }

    // پردازش درخواست‌های Webhook
    if (url.pathname.startsWith("/hook")) {
      const reqHook = url.pathname.split('/hook/')[1];

      if (reqHook == await botValues.get("webhookkey")) {
        if (request.method === "POST") {
          try {
            const body = await request.json();

            // پردازش callback_query
            if (body.callback_query) {
              const callbackQuery = body.callback_query;

              const is_registerd = await checkMember(callbackQuery.message.chat.id, callbackQuery.data);

              if (!is_registerd) {
                await postReq(`answerCallbackQuery`, [
                  { "callback_query_id": callbackQuery.id },
                  { "text": "شما در تعدادی از لینک‌های موجود هنوز عضو نشده‌اید. مجدد تلاش کنید." },
                  { "show_alert": true },
                ]);
              } else {
                await postReq(`answerCallbackQuery`, [
                  { "callback_query_id": callbackQuery.id }
                ]);
              }
            }

            // پردازش message
            if (body.message) {
              const chatId = body.message.chat.id;

              if (ADMINS.includes(body.message.chat.username)) {
                await postReq(`setMyCommands`, [
                  {
                    "scope": JSON.stringify({
                      type: 'chat',
                      chat_id: chatId
                    })
                  },
                  { "commands": JSON.stringify([{ command: '/newpost', description: 'پست جدید' }]) }
                ]);

                const setAct = async (act) => {
                  await botValues.put("action_" + chatId, JSON.stringify(act));
                };

                if (body.message.text == '/newpost') {
                  await postReq(`sendMessage`, [
                    { "chat_id": chatId },
                    { "text": "یه چیزی ارسال کنید متن ، فایل ، ویس ، هرچی ..." },
                  ]);
                  await setAct({ "act": "wait_for_post" });
                } else if (('text' in body.message && !body.message.text.startsWith("/start")) || !('text' in body.message)) {
                  try {
                    const command = JSON.parse(await botValues.get("action_" + chatId));

                    if (command.act == "wait_for_post") {
                      command["message_id"] = body.message.message_id;
                      command["act"] = "wait_for_channels";
                      await setAct(command);

                      await postReq(`sendMessage`, [
                        { "chat_id": chatId },
                        { "text": "کانال های عضو اجباری را وارد کنید" + "\n" + "به این صورت\n\n@channelID1 title1\n@channelID2 title2" },
                      ]);
                    } else if (command.act == "wait_for_channels") {
                      await postReq(`sendMessage`, [
                        { "chat_id": chatId },
                        { "text": "عنوان را وارد کنید" },
                      ]);

                      command["channels"] = body.message.text;
                      command["act"] = "wait_for_caption";
                      await setAct(command);
                    } else if (command.act == "wait_for_caption") {
                      let caption = {};

                      if ('caption' in body.message) {
                        caption = {
                          type: "file_with_caption",
                          message_id: body.message.message_id,
                          text: body.message.caption
                        };
                      } else if ('text' in body.message) {
                        caption = {
                          type: "text",
                          text: body.message.text
                        };
                      } else {
                        caption = {
                          type: "file_without_caption",
                          message_id: body.message.message_id,
                          text: ""
                        };
                      }

                      const insertNewPost = await botDB.prepare(`INSERT INTO posts (message_id, from_chat_id, channels, caption) VALUES (?1, ?2, ?3, ?4)`).bind(
                        String(command["message_id"]),
                        String(chatId),
                        String(command["channels"]),
                        String(JSON.stringify(caption)),
                      ).run();

                      const postCaption = "برای دریافت باید عضو" + body.message.text;

                      const buyBtn = JSON.stringify({
                        "inline_keyboard": [
                          [
                            {
                              "text": "دریافت فایل",
                              "url": `https://t.me/${BOT_ID}?start=${insertNewPost.meta.last_row_id}`
                            }
                          ]
                        ]
                      });

                      await postReq(`copyMessage`, [
                        { "chat_id": chatId },
                        { "from_chat_id": chatId },
                        { "message_id": body.message.message_id },
                        { "reply_markup": buyBtn }
                      ]);

                      await setAct({ "act": "idle" });
                    }
                  } catch (e) {
                    // خطا را نادیده بگیر
                  }
                }
              }

              if (body.message.text.startsWith("/start")) {
                const postid = body.message.text.match(/\/start (\w+)/)[1];
                if (postid) {
                  await botValues.put("registerMsg_" + chatId, "");
                }
                await checkMember(chatId, postid);
              }
            }
          } catch (e) {
            // خطا را نادیده بگیر
          }
        }
        return new Response("", { status: 200 });
      } else {
        return new Response("wrong webhook", { status: 200 });
      }
    }

    return new Response("ok", { status: 200 });
  }
};